# Getting Started - Dream Protocol Identity Module

## Prerequisites

- **Node.js** 18+
- **pnpm** 8+ (`npm install -g pnpm`)
- **PostgreSQL** 14+ (or use Docker)
- **Docker** (optional, but recommended)

## Quick Start (Docker - Easiest)

```bash
# 1. Run setup script
./scripts/setup.sh

# 2. Start everything (database + identity module)
docker-compose up

# 3. Test the API
curl http://localhost:3001/health
```

That's it! The Identity module is now running on `http://localhost:3001`

## Manual Setup (Without Docker)

### 1. Install Dependencies

```bash
./scripts/setup.sh
```

This will:
- Install all npm dependencies
- Create `.env` with generated encryption keys
- Set up the monorepo workspace

### 2. Start PostgreSQL

**Option A: Use Docker**
```bash
docker-compose up -d postgres
```

**Option B: Use local PostgreSQL**
```bash
# Create database
createdb dreamprotocol_dev

# Update .env with your PostgreSQL credentials
```

### 3. Run Migrations

```bash
# Apply all database migrations
psql $DATABASE_URL -f database/migrations/001_create_users_table.sql
psql $DATABASE_URL -f database/migrations/002_create_dual_wallets.sql
psql $DATABASE_URL -f database/migrations/003_create_identity_tables.sql
```

### 4. Start Identity Module

```bash
# Development mode (with auto-reload)
pnpm identity:dev

# Or build and run
pnpm --filter @dream/identity build
node packages/01-identity/dist/index.js
```

## Testing the API

### Health Check
```bash
curl http://localhost:3001/health
```

### Create Dual Identity
```bash
curl -X POST http://localhost:3001/api/v1/identity/create-dual \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "user_123",
    "password": "YourSecurePassword123!"
  }'
```

Response:
```json
{
  "success": true,
  "data": {
    "message": "Dual identity created successfully",
    "identities": {
      "true_self": {
        "did": "did:agoranet:user_123_true_self",
        "cardanoAddress": "addr1v...",
        "mode": "true_self",
        "walletId": "..."
      },
      "shadow": {
        "did": "did:agoranet:user_123_shadow",
        "cardanoAddress": "addr1v...",
        "mode": "shadow",
        "walletId": "..."
      }
    },
    "createdAt": "2025-01-30T..."
  }
}
```

### Get Current Identity
```bash
curl http://localhost:3001/api/v1/identity/current/user_123
```

### Switch Identity Mode
```bash
curl -X POST http://localhost:3001/api/v1/identity/switch-mode \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "user_123",
    "mode": "shadow",
    "sessionId": "session_id_here"
  }'
```

## Project Structure

```
dreamprotocol/
├── packages/
│   └── 01-identity/           # Identity Module
│       ├── src/
│       │   ├── services/      # Core business logic
│       │   ├── routes/        # API endpoints
│       │   ├── types/         # TypeScript types
│       │   └── utils/         # Utilities (encryption, DB)
│       └── package.json
├── database/
│   └── migrations/            # SQL migrations
├── docker-compose.yml         # Docker setup
├── .env.example              # Environment template
└── scripts/
    └── setup.sh              # Setup script
```

## Environment Variables

Key variables in `.env`:

```bash
# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=dreamprotocol_dev
DB_USER=dream_admin
DB_PASSWORD=your_password

# Security (auto-generated by setup.sh)
MASTER_ENCRYPTION_KEY=...
IP_HASH_SALT=...

# Cardano Network
CARDANO_NETWORK=testnet

# API
API_PORT=3001
```

## Development Commands

```bash
# Install dependencies
pnpm install

# Start Identity module (dev mode)
pnpm identity:dev

# Build Identity module
pnpm --filter @dream/identity build

# Run tests
pnpm --filter @dream/identity test

# Lint code
pnpm lint

# Format code
pnpm format
```

## Docker Commands

```bash
# Start all services
docker-compose up

# Start in background
docker-compose up -d

# Stop all services
docker-compose down

# View logs
docker-compose logs -f identity

# Rebuild after code changes
docker-compose up --build
```

## What's Working

✅ **Dual Identity Creation**
- Generate True Self and Shadow Cardano wallets
- Create W3C-compliant DIDs
- Encrypt private keys with user password
- Store encrypted linkage in DualityToken

✅ **Identity Mode Switching**
- Switch between True Self and Shadow
- Track mode history with audit trail
- Session management

✅ **Security**
- AES-256-GCM encryption
- Password-based key derivation (PBKDF2)
- Master key encryption for DualityToken
- IP address hashing
- Secure database access controls

✅ **Database**
- PostgreSQL with proper indexes
- 7 tables (users, dual_wallets, DIDs, duality_tokens, utxo_pools, sessions, history)
- Audit trails

✅ **API**
- RESTful endpoints
- Error handling
- CORS support
- Health checks

## Next Steps

1. **Add Authentication Middleware** - JWT or session-based auth
2. **Implement Remaining Modules**:
   - Module 02: Governance (voting with dual identities)
   - Module 03: Economy (PollCoin + Gratium tokens)
   - Module 04: Analytics (Shadow Consensus calculator)
   - ... (18 more modules)
3. **Add Tests** - Unit and integration tests
4. **Frontend** - Build Next.js app in `apps/flagship`
5. **Deploy to Staging** - Test in cloud environment

## Troubleshooting

**Database connection failed**
```bash
# Check PostgreSQL is running
docker-compose ps postgres

# Check logs
docker-compose logs postgres
```

**Port 3001 already in use**
```bash
# Change port in .env
API_PORT=3002
```

**pnpm: command not found**
```bash
npm install -g pnpm
```

## Support

- Documentation: See `doc files/MODULE_01_IDENTITY_TECHNICAL_PLAN.md`
- Architecture: See `DREAM_PROTOCOL.md`

---

**Built with TypeScript, PostgreSQL, Cardano SDK, and Express.js**
